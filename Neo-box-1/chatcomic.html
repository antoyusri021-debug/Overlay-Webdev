<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webdev Ultimate Sync - Fixed Transitions</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --radius: 20px;
            --font-size: 15px;
            --u-color: #fff;
            --t-color: #111;
            --bg-color: rgba(255, 255, 255, 0.85);
            --border-color: rgba(255, 255, 255, 0.65);
            --avt-radius: 50%; /* Default Circle */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: transparent;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #container {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- CORE ANIMATION LOGIC --- */
        .message-wrapper {
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); /* Efek kenyal/elastic */
            will-change: transform, opacity;
        }

        /* 1. Fade In */
        .message-wrapper.fade-in { transform: scale(0.9); }
        .message-wrapper.fade-in.show { opacity: 1; transform: scale(1); }

        /* 2. Slide Left */
        .message-wrapper.slide-left { transform: translateX(-100px); }
        .message-wrapper.slide-left.show { opacity: 1; transform: translateX(0); }

        /* 3. Slide Up */
        .message-wrapper.slide-up { transform: translateY(100px); }
        .message-wrapper.slide-up.show { opacity: 1; transform: translateY(0); }

        /* 4. Bounce Pop */
        .message-wrapper.bounce { transform: scale(0); }
        .message-wrapper.bounce.show { 
            opacity: 1; 
            transform: scale(1); 
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Exit Animation */
        .message-wrapper.hide {
            opacity: 0 !important;
            transform: scale(0.8) translateY(-20px) !important;
            filter: blur(10px);
            transition: all 0.4s ease-in;
        }

        /* --- CARD STYLING --- */
        .message {
            width: 260px;
            height: 320px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative; 
            background: var(--bg-color);
            backdrop-filter: blur(14px);
            border-radius: var(--radius);
            border: 1.5px solid var(--border-color);
            box-shadow: 0 15px 45px rgba(0,0,0,0.25);
        }

        .avatar {
            width: 100%;
            height: 220px;
            object-fit: cover;
            display: block;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            /* Avatar shape dikontrol via JS updateCSSVariables */
            border-radius: var(--avt-radius); 
        }

        /* Icon TikTok */
        .message::after {
            content: "";
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            background: url('https://i.ibb.co/v4m8YmP/tiktok-icon.png') no-repeat center;
            background-size: contain;
            z-index: 30;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .username {
            position: absolute;
            left: 10px;
            top: 180px;
            font-size: 13px;
            font-weight: 800;
            color: var(--u-color);
            padding: 5px 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 20;
            max-width: 85%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .message-content {
            padding: 12px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .text {
            font-size: var(--font-size);
            font-weight: 600;
            line-height: 1.4;
            color: var(--t-color);
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="output"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('session') || 'TESTROOM';
        const password = urlParams.get('password') || "false";
        
        let currentMessage = null;
        let hideTimeout = null;
        // Ambil animasi dari URL, default slide-up biar keren
        let currentAnim = urlParams.get('anim') || 'slide-up';

        // 1. URL Parameter Sync
        function applyUrlSettings() {
            const r = urlParams.get('radius') || '20';
            const f = urlParams.get('font') || '15';
            const uc = urlParams.get('ucolor') || 'ffffff';
            const tc = urlParams.get('tcolor') || '111111';
            const bc = urlParams.get('bcolor') || 'ffffff';
            const bo = urlParams.get('bopac') || '0.65';
            const avt = urlParams.get('avt') || 'circle';
            
            let background = "#ffffff";
            if(urlParams.get('grad')) {
                const colors = urlParams.get('grad').split(',');
                background = `linear-gradient(135deg, #${colors[0]}, #${colors[1]})`;
            } else {
                const bg = urlParams.get('bg') || 'ffffff';
                const op = urlParams.get('opac') || '0.85';
                background = hexToRgbA(bg, op);
            }

            updateCSSVariables({
                radius: r + 'px',
                font: f + 'px',
                uColor: '#' + uc,
                tColor: '#' + tc,
                bColor: hexToRgbA(bc, bo),
                bg: background,
                avt: avt
            });
        }

        // 2. Real-time Listener (Update Style Tanpa Refresh)
        window.addEventListener("message", (e) => {
            if (e.data.type === 'UPDATE_STYLE') {
                const d = e.data;
                currentAnim = d.anim; // Update tipe animasi secara real-time
                
                let background = d.bg;
                if(d.mode === 'gradient') {
                    background = `linear-gradient(135deg, ${d.g1}, ${d.g2})`;
                } else {
                    background = hexToRgbA(d.bg.replace('#',''), d.opac);
                }

                updateCSSVariables({
                    radius: d.radius + 'px',
                    font: d.font + 'px',
                    uColor: d.uColor,
                    tColor: d.tColor,
                    bColor: hexToRgbA(d.bColor.replace('#',''), d.bOpac),
                    bg: background,
                    avt: d.avtShape
                });
            }
        });

        function updateCSSVariables(data) {
            const root = document.documentElement.style;
            root.setProperty('--radius', data.radius);
            root.setProperty('--font-size', data.font);
            root.setProperty('--u-color', data.uColor);
            root.setProperty('--t-color', data.tColor);
            root.setProperty('--border-color', data.bColor);
            root.setProperty('--bg-color', data.bg);
            
            // Logic Avatar Shape
            let avtRad = "0%"; // Square
            if(data.avt === 'circle') avtRad = "50%";
            if(data.avt === 'squircle') avtRad = "20%";
            root.setProperty('--avt-radius', avtRad);
        }

        function hexToRgbA(hex, alpha) {
            let c;
            if (/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) {
                c = hex.substring(1).split('');
            } else { c = hex.split(''); }
            if (c.length == 3) c = [c[0], c[0], c[1], c[1], c[2], c[2]];
            c = '0x' + c.join('');
            return `rgba(${(c >> 16) & 255}, ${(c >> 8) & 255}, ${c & 255}, ${alpha})`;
        }

        function showMessage(content) {
            if (!content.chatmessage && !content.chatname) return;
            if (hideTimeout) clearTimeout(hideTimeout);

            hideMessage(() => {
                const wrapper = document.createElement('div');
                // Masukkan class animasi aktif ke wrapper
                wrapper.className = `message-wrapper ${currentAnim}`;
                
                const photo = content.chatimg || `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(content.chatname)}`;

                wrapper.innerHTML = `
                    <div class="message">
                        <img src="${photo}" class="avatar" onerror="this.src='https://api.dicebear.com/7.x/initials/svg?seed=User'">
                        <div class="username">${content.chatname}</div>
                        <div class="message-content">
                            <div class="text">${content.chatmessage}</div>
                        </div>
                    </div>`;
                
                const output = document.getElementById('output');
                output.innerHTML = '';
                output.appendChild(wrapper);

                // Jalankan animasi masuk setelah element di-render
                setTimeout(() => { wrapper.classList.add('show'); }, 50);
                
                currentMessage = wrapper;

                const showDuration = parseInt(urlParams.get('showtime')) || 0; 
                if (showDuration > 0) {
                    hideTimeout = setTimeout(() => { hideMessage(); }, showDuration);
                }
            });
        }

        function hideMessage(callback) {
            if (currentMessage) {
                currentMessage.classList.add('hide'); 
                currentMessage.classList.remove('show');
                setTimeout(() => {
                    if (currentMessage && currentMessage.parentNode) {
                        currentMessage.parentNode.removeChild(currentMessage);
                    }
                    currentMessage = null;
                    if (callback) callback();
                }, 450);
            } else if (callback) {
                callback();
            }
        }

        // Ninja Connection
        function createIframe() {
            var iframe = document.createElement("iframe");
            iframe.src = "https://vdo.socialstream.ninja/?ln&password=" + password + "&notmobile&salt=vdo.ninja&label=overlay&exclude=" + roomID + "&scene&novideo&noaudio&cleanoutput&room=" + roomID;
            iframe.style.width = "0px"; iframe.style.height = "0px"; iframe.style.position = "fixed";
            document.body.appendChild(iframe);

            window.addEventListener("message", function (e) {
                if (e.source != iframe.contentWindow) return;
                if (e.data.dataReceived && e.data.dataReceived.overlayNinja) {
                    showMessage(e.data.dataReceived.overlayNinja);
                }
            });
        }

        applyUrlSettings();
        createIframe();
    </script>
</body>
</html>
