<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Social Stream - Overlay Premium Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* =========================
           CHAT STYLE REVAMP
        ========================= */
        .highlight-chat {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            position: relative;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        /* Animasi Masuk */
        .highlight-chat.show {
            animation: wiggleFade 0.5s ease-out forwards;
        }

        /* Animasi Keluar */
        .highlight-chat.hide {
            opacity: 0 !important;
            transform: translateX(20px) scale(0.95);
        }

        .hl-title {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .hl-img {
            position: absolute;
            left: 0;
            top: 44px; 
            display: block !important;
        }

        .hl-profile-pic {
            width: 52px !important;
            height: 52px !important;
            border-radius: 50% !important;
            border: 2px solid rgba(255,255,255,0.15);
            background: #000;
            object-fit: cover !important;
            z-index: 2;
        }

        .hl-name {
            background: #ffffff !important;
            color: #000000 !important;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 700;
            line-height: 1;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            margin-left: 64px !important;
            font-family: 'Roboto', sans-serif !important;
        }

        .hl-message {
            position: relative;
            margin-left: 64px;
            background: rgba(23,25,35,0.92);
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.6;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.08);
            max-width: 320px;
            width: fit-content;
            color: #ffffff !important;
            word-wrap: break-word;
            font-family: 'Roboto', sans-serif !important;
        }

        .hl-message::before {
            content: "";
            position: absolute;
            top: 16px;
            left: -10px;
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 12px solid rgba(23,25,35,0.92);
        }

        /* DONATION STYLE */
        .highlight-chat.dono .hl-message {
            background: linear-gradient(135deg,#f5c542,#c99b1f);
            color: #1a1200 !important;
            font-weight: 700;
            border: 1px solid rgba(255,215,64,0.8);
        }
        .highlight-chat.dono .hl-message::before { border-right-color: #c99b1f; }
        .highlight-chat.dono .hl-name { background: #d4af37 !important; color: #1a1200 !important; }

        .output {
            position: fixed !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            max-width: 420px;
            width: fit-content;
        }

        .highlight-chat::after {
            content: "WEBDEV";
            position: absolute;
            bottom: -8px;
            right: 0;
            background: #8b0000;
            color: #ffffff;
            font-size: 0.55rem;
            font-weight: 800;
            padding: 3px 10px;
            border-radius: 6px;
            z-index: 10;
        }

        @keyframes wiggleFade {
            0% { transform: translateX(0); opacity: 0; }
            25% { transform: translateX(-4px); opacity: 1; }
            50% { transform: translateX(4px); }
            100% { transform: translateX(0); opacity: 1; }
        }

        #frame1 { display: none !important; }
    </style>
</head>
<body>
    <div id="output" class="output"></div>
    <script>
    const urlParams = new URLSearchParams(window.location.search);
    
    // TIMER CONFIG
    const globalShowtime = parseInt(urlParams.get('showtime') || urlParams.get('timer') || '10000');

    const App = {
        config: {
            serverURL: (urlParams.has("localserver") ? "ws://127.0.0.1:3000" : 'wss://io.socialstream.ninja'),
            maxReconnectAttempts: 10,
            reconnectDelay: 100,
            roomIdMaxLength: 80
        },

        state: {
            socketserver: null,
            roomID: 'test',
            password: 'false',
            currentTimeout: null
        },

        init() {
            this.setupUrlParams();
            this.initializeConnection();
        },

        setupUrlParams() {
            this.state.password = urlParams.get('password') || 'false';
            let roomID = urlParams.get('session') || urlParams.get('s') || urlParams.get('id');
            if (!roomID) roomID = 'TESTROOM';
            this.state.roomID = roomID;
        },

        initializeConnection() {
            this.setupRecvDataWindow();
        },

        setupRecvDataWindow() {
            const iframe = document.createElement('iframe');
            iframe.src = `https://vdo.socialstream.ninja/?ln&password=${this.state.password}&notmobile&salt=vdo.ninja&label=overlay&exclude=${this.state.roomID}&scene&novideo&noaudio&cleanoutput&room=${this.state.roomID}`;
            iframe.id = 'frame1';
            document.body.appendChild(iframe);

            window.addEventListener('message', (e) => {
                if (e.source !== iframe.contentWindow) return;
                if (e.data?.dataReceived && ("overlayNinja" in e.data.dataReceived)){
                    const content = e.data.dataReceived.overlayNinja;
                    if (content && content.chatmessage) {
                        this.showMessage(content);
                    }
                }
            });
        },

        showMessage(data) {
            const output = document.getElementById('output');
            
            // Clear previous timer
            if (this.state.currentTimeout) clearTimeout(this.state.currentTimeout);
            
            const chatHtml = this.buildMessageContent(data);
            output.innerHTML = chatHtml;

            const newMsg = document.getElementById('newmessage');
            
            // Handle Dono Class
            if (data.hasDonation || data.donation) {
                newMsg.classList.add('dono');
            }

            // Animation In
            requestAnimationFrame(() => {
                newMsg.classList.add('show');
            });

            // LOGIKA AUTO HIDE
            if (globalShowtime > 0) {
                this.state.currentTimeout = setTimeout(() => {
                    newMsg.classList.add('hide');
                    setTimeout(() => {
                        output.innerHTML = '';
                    }, 500);
                }, globalShowtime);
            }
        },

        buildMessageContent(data) {
            const avatarImg = data.chatimg || './sources/images/unknown.png';
            const type = data.type || 'none';
            
            return `
                <div class="highlight-chat" id="newmessage">
                    <div class="hl-title">
                        <div class="hl-img">
                            <img src="${avatarImg}" class="hl-profile-pic" onerror="this.src='./sources/images/unknown.png'">
                        </div>
                        <div class="hl-name">${data.chatname || 'User'}</div>
                    </div>
                    <div class="hl-message">${data.chatmessage}</div>
                    <img src="./sources/images/${type}.png" class="icon sourcetype" style="position:absolute; top:-6px; right:-6px; width:20px; opacity:0.7;" onerror="this.style.display='none'">
                </div>
            `;
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
