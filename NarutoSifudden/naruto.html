<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naruto Shinobi Chat - Final High Position</title>
    <style>
/* ===============================
   THEME: NARUTO SHINOBI (FINAL)
   STATUS: KURAMA RAISED HIGHER
================================ */
@import url('https://fonts.googleapis.com/css2?family=Teko:wght@500;700&family=Permanent+Marker&display=swap');

:root {
    --bg-scroll: #fcf4dd; 
    --naruto-orange: #ff6b00; 
    --konoha-blue: #1b263b;
    --border-red: #8d0801;
    --chat-color: #111111;
    --font-size: 26px;
}

body { 
    background: transparent !important; 
    font-family: 'Teko', sans-serif; 
    margin: 0;
    overflow: hidden;
}

#container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 100vh;
    padding-left: 20px;
}

.message-wrapper { 
    position: relative;
    opacity: 0; 
    transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1); 
    margin-top: 150px; /* Ruang lega buat Kurama yang tinggi */
    display: inline-block;
}

/* CONTAINER KARAKTER */
.char-container {
    position: absolute;
    left: 90px; 
    top: -160px; /* Default buat Naruto */
    width: 190px; 
    z-index: 5; 
    pointer-events: none;
    filter: drop-shadow(0px 0px 15px rgba(255,107,0,0.6));
}

/* KHUSUS KURAMA - Kita tembak pakai class dinamis nanti */
.char-container.kurama-mode {
    top: -185px; /* Kurama naik lebih tinggi lagi dibanding Naruto */
    width: 210px; /* Kurama dibikin lebih lebar dikit biar garang */
}

.char-img {
    width: 100%;
    height: auto;
    display: block;
    transform: translateY(40px);
    transition: transform 0.6s ease-out;
}

.show .char-img {
    transform: translateY(0);
}

.message-content-wrapper {
    display: flex;
    align-items: flex-end; 
    gap: 12px;
    position: relative;
    z-index: 100;
}

.avatar-box {
    width: 90px;
    height: 90px;
    flex-shrink: 0;
    position: relative;
    z-index: 110;
}

.avatar {
    width: 100%;
    height: 100%;
    border: 4px solid var(--konoha-blue);
    background: #fff;
    object-fit: cover;
    box-shadow: 5px 5px 0px var(--naruto-orange);
}

.message {
    position: relative;
    display: flex; 
    flex-direction: column;
    justify-content: center;
    padding: 12px 25px; 
    background: var(--bg-scroll); 
    border-top: 3px solid var(--border-red);
    border-bottom: 3px solid var(--border-red);
    border-left: 10px solid var(--border-red);
    width: 480px; 
    min-height: 95px;      
    box-sizing: border-box;
    box-shadow: 10px 10px 20px rgba(0,0,0,0.3);
}

.username-container {
    position: absolute;
    top: -34px; left: 10px;
    display: flex;
    align-items: center;
    z-index: 120;
}

.level-tag {
    background: var(--konoha-blue);
    color: #fff;
    border: 1px solid var(--naruto-orange);
    padding: 1px 10px;
    font-size: 16px;
    font-weight: bold;
}

.username {
    background: var(--naruto-orange);
    padding: 3px 25px 3px 12px;
    color: #fff !important;
    font-family: 'Permanent Marker', cursive;
    font-size: 18px; 
    text-transform: uppercase;
    clip-path: polygon(0 0, 92% 0, 100% 100%, 0 100%);
}

/* TEKS LIMIT 2 BARIS */
.text { 
    font-size: var(--font-size); 
    font-weight: 600; 
    color: var(--chat-color) !important;
    line-height: 1.2;
    text-transform: uppercase;
    display: -webkit-box;
    -webkit-line-clamp: 2; 
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ANIMATIONS */
.show { opacity: 1; transform: scale(1); }
.message-wrapper.anim-slide-left { transform: translateX(-100px); }
.show.anim-slide-left { transform: translateX(0); }

.message-wrapper.hide { 
    opacity: 0; 
    transform: translateY(-20px); 
    filter: blur(5px); 
}
    </style>
</head>
<body>
    <div id="container"><div id="output"></div></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('session') || 'TESTROOM';
        const password = urlParams.get('password') || "false";
        let showDuration = parseInt(urlParams.get('showtime') || '10000'); 
        let selectedAnim = urlParams.get('anim') || 'slide-left';

        const characters = ['narutomod.png', 'kurama.png'];

        function createIframe() {
            var iframe = document.createElement("iframe");
            iframe.src = `https://vdo.socialstream.ninja/?ln&password=${password}&notmobile&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`;
            iframe.style.display = "none";
            document.body.appendChild(iframe);
            window.addEventListener("message", function (e) {
                if (e.source != iframe.contentWindow) return;
                if (e.data.dataReceived && e.data.dataReceived.overlayNinja) {
                    let res = e.data.dataReceived.overlayNinja;
                    if (res.chatmessage) showMessage(res);
                }
            });
        }

        let currentMessage = null;
        let hideTimeout = null;

        function showMessage(content) {
            if (hideTimeout) clearTimeout(hideTimeout);
            hideMessage(() => {
                const output = document.getElementById('output');
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper anim-${selectedAnim}`;
                
                const randomChar = characters[Math.floor(Math.random() * characters.length)];
                // Logika buat deteksi Kurama
                const charClass = randomChar === 'kurama.png' ? 'char-container kurama-mode' : 'char-container';
                
                const avatarImg = content.chatimg || content.avatar || `https://api.dicebear.com/7.x/initials/svg?seed=${content.chatname}`;
                
                wrapper.innerHTML = `
                    <div class="${charClass}">
                        <img src="${randomChar}" class="char-img">
                    </div>
                    <div class="message-content-wrapper">
                        <div class="avatar-box">
                            <img class="avatar" src="${avatarImg}">
                        </div>
                        <div class="message">
                            <div class="username-container">
                                <div class="level-tag">SHINOBI</div>
                                <span class="username">${content.chatname}</span>
                            </div>
                            <div class="text">${content.chatmessage}</div>
                        </div>
                    </div>`;
                
                output.appendChild(wrapper);
                setTimeout(() => wrapper.classList.add('show'), 50);
                currentMessage = wrapper;
                if (showDuration > 0) hideTimeout = setTimeout(() => hideMessage(), showDuration);
            });
        }

        function hideMessage(callback) {
            if (currentMessage) {
                currentMessage.classList.add('hide');
                setTimeout(() => {
                    if (currentMessage?.parentNode) currentMessage.parentNode.removeChild(currentMessage);
                    currentMessage = null;
                    if (callback) callback();
                }, 400);
            } else if (callback) callback();
        }

        createIframe();
    </script>
</body>
</html>