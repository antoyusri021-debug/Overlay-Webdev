<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPhone Style - Fix Avatar TikTok</title>
    <style>
        body {
            background: transparent !important;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            -webkit-font-smoothing: antialiased;
        }

        #container {
            display: flex;
            align-items: center; /* Tengah Vertikal */
            justify-content: flex-start; /* Rata Kiri */
            height: 100vh;
            padding-left: 30px;
        }

        .message-wrapper {
            position: relative;
            width: 420px; 
            min-height: 100px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 24px;
            border: 0.5px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            display: flex;
            gap: 15px;
            align-items: center;
            box-sizing: border-box;
            animation: iosSlideLeft 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        @keyframes iosSlideLeft {
            0% { opacity: 0; transform: translateX(-40px) scale(0.95); }
            100% { opacity: 1; transform: translateX(0) scale(1); }
        }

        /* AVATAR STYLE - Menggunakan variabel chatimg */
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 14px; /* iOS Squircle */
            background: #eee;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .username {
            font-size: 16px;
            font-weight: 700;
            color: #000;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .username::after {
            content: 'now';
            font-size: 11px;
            font-weight: 400;
            color: rgba(0, 0, 0, 0.3);
        }

        .text {
            font-size: 15px;
            line-height: 1.35;
            color: #1c1c1e;
            font-weight: 400;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="output"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('session') || urlParams.get('room') || 'TESTROOM';
        const password = urlParams.get('password') || "false";

        function createIframe() {
            var iframe = document.createElement("iframe");
            iframe.src = `https://vdo.socialstream.ninja/?ln&password=${password}&notmobile&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`;
            iframe.style.display = "none";
            document.body.appendChild(iframe);

            window.addEventListener("message", function (e) {
                if (e.source != iframe.contentWindow) return;
                
                if ("dataReceived" in e.data) {
                    if ("overlayNinja" in e.data.dataReceived) {
                        const ninjaData = e.data.dataReceived.overlayNinja;
                        // Mengikuti logika referensi kamu: cek contents
                        if (ninjaData && !ninjaData.response) {
                            updateMessage(ninjaData);
                        }
                    }
                }
            });
        }

        function updateMessage(content) {
            if (!content.chatmessage && !content.chatname) return;

            const output = document.getElementById('output');
            output.innerHTML = ''; // Satu tampilan saja

            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';

            // REFERENSI VARIABEL: chatimg (foto profil), chatname (nama), chatmessage (isi)
            const photoUrl = content.chatimg ? content.chatimg : 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + content.chatname;
            
            wrapper.innerHTML = `
                <img src="${photoUrl}" class="avatar" onerror="this.src='https://api.dicebear.com/7.x/initials/svg?seed=${content.chatname}'">
                <div class="content">
                    <div class="username">${content.chatname}</div>
                    <div class="text">${content.chatmessage}</div>
                </div>
            `;

            output.appendChild(wrapper);

            // Auto-hide setelah 10 detik agar layar bersih
            clearTimeout(window.hideTimeout);
            window.hideTimeout = setTimeout(() => {
                wrapper.style.transition = '0.5s ease-in';
                wrapper.style.opacity = '0';
                wrapper.style.transform = 'translateX(-20px) scale(0.95)';
            }, 10000);
        }

        createIframe();
    </script>
</body>
</html>