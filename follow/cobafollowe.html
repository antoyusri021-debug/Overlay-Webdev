<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webdev Broadcast - Smart Detection</title>
    <style>
        :root {
            --accent: #ffffff;
            --glass: rgba(10, 10, 15, 0.95);
        }

        body { 
            background: transparent; 
            font-family: 'Poppins', sans-serif; 
            margin: 0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center; 
            align-items: center;     
        }

        .spotlight-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 450px;
            padding: 40px;
            background: var(--glass);
            border-radius: 40px;
            border: 2px solid var(--accent);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
            opacity: 0;
            transform: scale(0.7);
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }

        .spotlight-wrapper.show { opacity: 1; transform: scale(1); }

        .avatar-spotlight {
            width: 170px;
            height: 170px;
            border-radius: 50%;
            border: 4px solid var(--accent);
            margin-bottom: 25px;
            object-fit: cover;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .user-name { color: var(--accent); font-weight: 800; font-size: 28px; text-transform: uppercase; }
        .action-text { color: rgba(255, 255, 255, 0.7); font-size: 18px; font-weight: 300; margin: 5px 0; }
        .info-detail { color: white; font-size: 32px; font-weight: 900; margin: 10px 0; }
        .thanks-note { color: var(--accent); font-size: 19px; font-style: italic; margin-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2); padding-top: 15px; width: 100%; }
        .branding-badge { background: var(--accent); color: black; font-size: 11px; font-weight: 900; padding: 5px 15px; border-radius: 20px; margin-bottom: 15px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="output"></div>
    <audio id="tts-audio" style="display:none;"></audio>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('room') || urlParams.get('session') || 'TESTROOM';
        const password = urlParams.get('password') || "false";

        let eventQueue = [];
        let isShowing = false;

        function playGoogleTTS(text) {
            const audio = document.getElementById('tts-audio');
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=id&client=tw-ob`;
            audio.src = url;
            audio.playbackRate = 1.25; 
            audio.play().catch(e => console.log("Klik 'Interact' di OBS!"));
        }

        function connectToNinja() {
            var iframe = document.createElement("iframe");
            iframe.src = "https://vdo.socialstream.ninja/?ln&password=" + password + "&notmobile&salt=vdo.ninja&label=overlay&exclude=" + roomID + "&scene&novideo&noaudio&cleanoutput&room=" + roomID;
            iframe.style.width = "0px"; iframe.style.height = "0px"; iframe.style.position = "fixed";
            document.body.appendChild(iframe);

            window.addEventListener("message", function (e) {
                if (e.source != iframe.contentWindow) return;
                if (e.data && e.data.dataReceived && e.data.dataReceived.overlayNinja) {
                    let res = e.data.dataReceived.overlayNinja;
                    let msg = (res.chatmessage || "").toLowerCase();
                    
                    // 1. CEK GIFT DULU
                    if (res.hasDonation) {
                        eventQueue.push({ type: 'gift', data: res });
                    } 
                    // 2. CEK FOLLOW (Berdasarkan kata kunci di pesan sistem)
                    else if (msg.includes("followed") || msg.includes("mengikuti") || msg.includes("baru saja mengikuti")) {
                        eventQueue.push({ type: 'follow', data: res });
                    }

                    processQueue();
                }
            });
        }

        function processQueue() {
            if (isShowing || eventQueue.length === 0) return;
            isShowing = true;
            renderEvent(eventQueue.shift());
        }

        function renderEvent(event) {
            const output = document.getElementById('output');
            const content = event.data;
            const name = content.chatname || 'Seseorang';
            const intro = "Saya adalah asisten webdev broadcast. ";
            let actionText, detailText, closingMsg, audioText;

            if (event.type === 'gift') {
                actionText = "Telah Mengirim Donasi";
                detailText = content.hasDonation;
                closingMsg = "Terima kasih sudah mampir ya!";
                audioText = `${intro} ${name} telah mengirim donasi gifnya ${detailText}. ${closingMsg}`;
            } else {
                actionText = "Baru Saja Mengikuti";
                detailText = "New Follower!";
                closingMsg = "Terima kasih sudah bergabung!";
                audioText = `${intro} ${name} baru saja mengikuti kita. ${closingMsg}`;
            }

            output.innerHTML = `
                <div class="spotlight-wrapper">
                    <div class="branding-badge">Webdev Broadcast Assistant</div>
                    <img class="avatar-spotlight" src="${content.chatimg || 'https://via.placeholder.com/170'}" onerror="this.src='https://via.placeholder.com/170'">
                    <div class="user-name">${name}</div>
                    <div class="action-text">${actionText}</div>
                    <div class="info-detail">${detailText}</div>
                    <div class="thanks-note">"${closingMsg} ðŸ”¥"</div>
                </div>
            `;
            
            const wrapper = output.querySelector('.spotlight-wrapper');
            setTimeout(() => {
                wrapper.classList.add('show');
                playGoogleTTS(audioText); 
            }, 100);

            setTimeout(() => {
                wrapper.classList.remove('show');
                setTimeout(() => {
                    output.innerHTML = '';
                    isShowing = false;
                    processQueue();
                }, 700);
            }, 9500); 
        }

        window.onload = connectToNinja;
    </script>
</body>
</html>