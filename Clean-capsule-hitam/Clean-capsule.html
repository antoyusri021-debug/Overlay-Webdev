<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webdev Fixed Size - TikTok Style Atmosphere</title>
    <style>
        /* ===============================
           BASE & VARIABLES
        ================================ */
        :root {
            --bg-color: rgba(255, 255, 255, 0.1);
            --radius: 100px;
            --font-size: 18px;
            --user-color: #000000;
            --chat-color: #111111;
        }

        body {
            margin: 0; padding: 0;
            background: transparent;
            overflow: hidden;
            font-family: Arial, Helvetica, sans-serif;
        }

        #container {
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            height: 100vh; width: 100vw;
        }

        /* ===============================
           ANIMATION SYSTEM
        ================================ */
        .message-wrapper { transition: all 0.5s ease; opacity: 0; }
        
        /* Fade In */
        .anim-fade-in { transform: translateX(50px) scale(0.9); }
        .anim-fade-in.show { opacity: 1; transform: translateX(0) scale(1); }

        /* Slide Left */
        .anim-slide-left { transform: translateX(-100px); }
        .anim-slide-left.show { opacity: 1; transform: translateX(0); }

        /* Slide Up */
        .anim-slide-up { transform: translateY(50px); }
        .anim-slide-up.show { opacity: 1; transform: translateY(0); }

        /* Bounce Pop */
        .anim-bounce { transform: scale(0.3); }
        .anim-bounce.show { opacity: 1; transform: scale(1); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }

        .message-wrapper.hide { opacity: 0; transform: scale(0.8) translateY(20px); filter: blur(10px); }

        /* ===============================
           BUBBLE DESIGN
        ================================ */
        .message {
            position: relative;
            display: flex; align-items: center;
            gap: 16px;
            width: 500px; 
            min-height: 80px;
            box-sizing: border-box;
            padding: 15px 25px;
            
            background: var(--bg-color) !important; 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            
            border: 3.5px solid #000000; /* Border tetap bold khas TikTok */
            border-radius: var(--radius);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }

        .avatar {
            width: 65px; height: 65px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 2.5px solid #000;
        }

        .message-content {
            display: flex; flex-direction: column;
            justify-content: center;
            flex-grow: 1; min-width: 0; 
        }

        .header { display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }

        .username {
            font-size: 1rem; font-weight: 900;
            color: var(--user-color) !important;
            white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; max-width: 200px;
        }

        .username::after {
            content: ""; display: inline-block;
            width: 18px; height: 18px;
            background-image: url("tiktok.png");
            background-repeat: no-repeat; background-position: center;
            background-size: contain; margin-left: 6px;
            vertical-align: middle;
        }

        .text {
            font-size: var(--font-size);
            font-weight: 700; line-height: 1.3;
            color: var(--chat-color) !important;
            word-wrap: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .badges img { width: 18px; height: 18px; }
        .source-icon, .donation-info, .content-image { display: none !important; }
    </style>
</head>
<body>
    <div id="container">
        <div id="output"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('session') || urlParams.get('room') || 'TESTROOM';
        const password = urlParams.get('password') || "false";
        let showtime = parseInt(urlParams.get('showtime') || urlParams.get('timer') || '10000');
        let selectedAnim = urlParams.get('anim') || 'fade-in';

        let messageTimeout = null;
        let currentMessage = null;

        // --- 1. ATMOSPHERE SYNC ENGINE ---
        function hexToRgba(hex, alpha) {
            if (!hex) return `rgba(255, 255, 255, ${alpha})`;
            hex = hex.replace('#', '');
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function applyStyles(isRealtime, data = null) {
            const root = document.documentElement;
            const source = isRealtime ? data : {
                radius: urlParams.get('radius'),
                font: urlParams.get('font'),
                uColor: urlParams.get('ucolor') ? '#' + urlParams.get('ucolor') : null,
                tColor: urlParams.get('tcolor') ? '#' + urlParams.get('tcolor') : null,
                bg: urlParams.get('bg'),
                opac: urlParams.get('opac') || '0.95',
                grad: urlParams.get('grad'),
                anim: urlParams.get('anim')
            };

            // Radius & Font
            if (source.radius) root.style.setProperty('--radius', source.radius + 'px');
            if (source.font) root.style.setProperty('--font-size', source.font + 'px');
            if (source.uColor) root.style.setProperty('--user-color', source.uColor);
            if (source.tColor) root.style.setProperty('--chat-color', source.tColor);
            if (source.anim) selectedAnim = source.anim;

            // Background Logic
            if (isRealtime) {
                if (data.mode === 'gradient') {
                    root.style.setProperty('--bg-color', `linear-gradient(135deg, ${data.g1}, ${data.g2})`);
                } else {
                    root.style.setProperty('--bg-color', hexToRgba(data.bg, data.opac));
                }
            } else {
                if (source.grad) {
                    const colors = source.grad.split(',');
                    root.style.setProperty('--bg-color', `linear-gradient(135deg, #${colors[0]}, #${colors[1]})`);
                } else if (source.bg) {
                    root.style.setProperty('--bg-color', hexToRgba(source.bg, source.opac));
                }
            }
        }

        // --- 2. LISTENERS ---
        window.addEventListener("message", (e) => {
            if (e.data.type === 'UPDATE_STYLE') {
                applyStyles(true, e.data);
                if (e.data.timer) showtime = parseInt(e.data.timer);
            }
        });

        // --- 3. CORE FUNCTIONS ---
        function createIframe() {
            const iframe = document.createElement("iframe");
            iframe.src = `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`;
            iframe.style.display = "none";
            document.body.appendChild(iframe);

            window.addEventListener("message", (e) => {
                if (e.source !== iframe.contentWindow) return;
                if (e.data.dataReceived?.overlayNinja) {
                    const data = e.data.dataReceived.overlayNinja;
                    const content = data.contents || data;
                    if (content.chatmessage) showMessage(content);
                }
            });
        }

        function showMessage(content) {
            hideMessage(() => {
                const output = document.getElementById('output');
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper anim-${selectedAnim}`;

                const avatarSrc = content.chatimg || 'https://socialstream.ninja/images/unknown.png';
                let badgesHTML = '';
                if (content.chatbadges) {
                    content.chatbadges.forEach(b => {
                        const src = typeof b === 'string' ? b : b.src;
                        badgesHTML += `<img src="${src}"> `;
                    });
                }

                wrapper.innerHTML = `
                    <div class="message">
                        <img class="avatar" src="${avatarSrc}" onerror="this.src='https://socialstream.ninja/images/unknown.png'">
                        <div class="message-content">
                            <div class="header">
                                <span class="username">${content.chatname}</span>
                                <span class="badges">${badgesHTML}</span>
                            </div>
                            <div class="text">${content.chatmessage}</div>
                        </div>
                    </div>
                `;

                output.appendChild(wrapper);
                currentMessage = wrapper;
                setTimeout(() => wrapper.classList.add('show'), 50);

                if (showtime > 0) {
                    messageTimeout = setTimeout(() => hideMessage(), showtime);
                }
            });
        }

        function hideMessage(callback) {
            if (messageTimeout) clearTimeout(messageTimeout);
            if (currentMessage) {
                currentMessage.classList.add('hide');
                setTimeout(() => {
                    if (currentMessage?.parentNode) currentMessage.parentNode.removeChild(currentMessage);
                    currentMessage = null;
                    if (callback) callback();
                }, 500);
            } else if (callback) { callback(); }
        }

        // INIT
        applyInitialStyles: applyStyles(false);
        createIframe();
    </script>
</body>
</html>
